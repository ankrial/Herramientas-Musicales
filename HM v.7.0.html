<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas Musicales 2025.10</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }

        body.light {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        body.dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        body.dark .container {
            background: rgba(30, 30, 30, 0.95);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        body.dark h1 {
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            padding: 10px 20px;
            border: 3px solid;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        body.light .theme-toggle {
            background: #fff;
            color: #333;
            border-color: #000;
        }

        body.dark .theme-toggle {
            background: #333;
            color: #fff;
            border-color: #fff;
        }

        .module {
            background: white;
            border: 4px solid;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        body.light .module {
            border-color: #000;
        }

        body.dark .module {
            background: #2a2a2a;
            border-color: #fff;
        }

        .module h2 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        body.dark .module h2 {
            color: #60a5fa;
        }

        .help-btn {
            background: #fbbf24;
            color: #000;
            border: 3px solid #000;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }

        body.dark .help-btn {
            border-color: #fff;
        }

        .help-content {
            display: none;
            background: #fef3c7;
            color: #000;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 3px solid #fbbf24;
        }

        body.dark .help-content {
            background: #3a3a00;
            color: #fff;
            border-color: #fbbf24;
        }

        textarea, input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 3px solid;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            margin-bottom: 10px;
            background: white;
            color: #000;
        }

        body.light textarea, body.light input[type="text"], body.light select {
            border-color: #000;
        }

        body.dark textarea, body.dark input[type="text"], body.dark select {
            border-color: #fff;
        }

        .btn {
            padding: 12px 24px;
            border: 3px solid;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
            font-size: 1rem;
        }

        body.light .btn {
            border-color: #000;
        }

        body.dark .btn {
            border-color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-green { background: #22c55e; color: #000; }
        .btn-red { background: #ef4444; color: #fff; }
        .btn-purple { background: #a855f7; color: #fff; }
        .btn-blue { background: #3b82f6; color: #fff; }

        .btn.active {
            background: #7dd3fc;
            color: #000;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .semitone-counter {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px 20px;
            background: #e5e7eb;
            border: 3px solid #000;
            border-radius: 10px;
            min-width: 60px;
            text-align: center;
        }

        body.dark .semitone-counter {
            background: #4b5563;
            border-color: #fff;
        }

        .history-box {
            background: #f3f4f6;
            border: 3px solid #000;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        body.dark .history-box {
            background: #374151;
            border-color: #fff;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .theme-toggle {
                position: static;
                margin: 10px auto;
                display: block;
                width: fit-content;
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="light">
    <div class="container">
        <div class="header">
            <h1>üéµ Herramientas Musicales 2025.10</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåì Modo</button>
        </div>

        <!-- M√≥dulo 01: Transponer Notas -->
        <div class="module">
            <h2>
                üéº Transponer Notas Musicales
                <button class="help-btn" onclick="toggleHelp(1)">‚ùì Ayuda</button>
            </h2>
            <div id="help-1" class="help-content">
                <strong>Descripci√≥n:</strong> Transpone notas musicales por semitonos.<br>
                <strong>Uso:</strong> Pega tu texto con acordes, selecciona cu√°ntos semitonos transponer (+/-), elige el modo (sostenidos #, bemoles b, o solfeo).<br>
                <strong>Ejemplo:</strong> "Intro: C G Am F" con +2 semitonos ‚Üí "Intro: D A Bm G"<br>
                <strong>Notas bemoles:</strong> "Bb_C" con +1 semitono ‚Üí "B_C#" (elimina bemol)
            </div>
            
            <textarea id="transpose-input" rows="4" placeholder="Ingresa tus acordes aqu√≠..." oninput="transposeNotes()"></textarea>
            <textarea id="transpose-output" rows="12" readonly style="height: 300px; overflow-y: auto;"></textarea>
            
            <div class="controls">
                <button class="btn btn-blue" onclick="changeSemitones(-1)">-</button>
                <span class="semitone-counter" id="semitone-count">0</span>
                <button class="btn btn-blue" onclick="changeSemitones(1)">+</button>
                
                <button class="btn" id="mode-sharp" onclick="changeMode('sharp')">#</button>
                <button class="btn" id="mode-flat" onclick="changeMode('flat')">b</button>
                <button class="btn" id="mode-solfeo" onclick="changeMode('solfeo')">S</button>
                
                <button class="btn btn-purple" onclick="changeFontSize(-1)">A-</button>
                <button class="btn btn-purple" onclick="changeFontSize(0)">A</button>
                <button class="btn btn-purple" onclick="changeFontSize(1)">A+</button>
                
                <button class="btn btn-green" onclick="copyTransposed()">Copiar</button>
                <button class="btn btn-red" onclick="resetTranspose()">Reiniciar</button>
            </div>

            <div style="margin-top: 15px;">
                <input type="text" id="history-title" placeholder="T√≠tulo del historial...">
                <button class="btn btn-green" onclick="saveToHistory()">üíæ Guardar Historial</button>
                <button class="btn btn-red" onclick="deleteSelectedHistory()">üóëÔ∏è Eliminar Seleccionados</button>
            </div>

            <div id="history-list" class="history-box"></div>
        </div>

        <!-- M√≥dulo 02: Metr√≥nomo -->
        <div class="module">
            <h2>
                ‚è±Ô∏è Metr√≥nomo
                <button class="help-btn" onclick="toggleHelp(2)">‚ùì Ayuda</button>
            </h2>
            <div id="help-2" class="help-content">
                <strong>Descripci√≥n:</strong> Metr√≥nomo digital con efectos visuales y sonoros.<br>
                <strong>Uso:</strong> Ajusta BPM (40-240), selecciona comp√°s (2/4, 3/4, 4/4, 6/8) y subdivisi√≥n, luego presiona Iniciar.<br>
                <strong>Ejemplo:</strong> BPM 120, comp√°s 4/4, subdivisi√≥n en corcheas para pr√°ctica est√°ndar.
            </div>

            <div class="controls">
                <button class="btn btn-green" id="metronome-toggle" onclick="toggleMetronome()">‚ñ∂Ô∏è Iniciar</button>
                <button class="btn btn-blue" onclick="changeBPM(-5)">-</button>
                <span class="semitone-counter" id="bpm-display">120</span>
                <button class="btn btn-blue" onclick="changeBPM(5)">+</button>
                
                <select id="time-signature" onchange="updateMetronome()" style="padding: 10px; font-weight: bold;">
                    <option value="2/4">2/4</option>
                    <option value="3/4">3/4</option>
                    <option value="4/4" selected>4/4</option>
                    <option value="6/8">6/8</option>
                </select>
                
                <select id="subdivision" onchange="updateMetronome()" style="padding: 10px; font-weight: bold;">
                    <option value="1">Negras</option>
                    <option value="2">Corcheas</option>
                    <option value="3">Tresillos</option>
                    <option value="4">Semicorcheas</option>
                </select>
            </div>

            <div id="metronome-beats" style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;"></div>

            <div style="margin-top: 15px;">
                <input type="text" id="metronome-session-title" placeholder="T√≠tulo de sesi√≥n...">
                <button class="btn btn-green" onclick="saveMetronomeSession()">üíæ Guardar Sesi√≥n</button>
                <button class="btn btn-red" onclick="deleteSelectedMetronomeSessions()">üóëÔ∏è Eliminar Seleccionados</button>
            </div>

            <div id="metronome-sessions" class="history-box"></div>
        </div>

        <!-- M√≥dulo 03: Acordes y Escalas Arm√≥nicas -->
        <div class="module">
            <h2>
                üéπ Acordes y Escalas Arm√≥nicas
                <button class="help-btn" onclick="toggleHelp(3)">‚ùì Ayuda</button>
            </h2>
            <div id="help-3" class="help-content">
                <strong>Descripci√≥n:</strong> Muestra todas las notas y acordes de una escala seleccionada.<br>
                <strong>Uso:</strong> Selecciona una nota base (C, D, E...) y tipo de escala (Mayor, Menor, Pentat√≥nica...), presiona Mostrar Escalas.<br>
                <strong>Ejemplo:</strong> C Mayor mostrar√°: I-C (C, E, G), ii-Dm (D, F, A), iii-Em (E, G, B), etc.
            </div>

            <select id="scale-root" style="padding: 10px; font-weight: bold; margin-right: 10px;">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>

            <select id="scale-type" style="padding: 10px; font-weight: bold; margin-right: 10px;">
                <option value="major">Mayor</option>
                <option value="minor">Menor Natural</option>
                <option value="harmonic-minor">Menor Arm√≥nica</option>
                <option value="melodic-minor">Menor Mel√≥dica</option>
                <option value="pentatonic-major">Pentat√≥nica Mayor</option>
                <option value="pentatonic-minor">Pentat√≥nica Menor</option>
                <option value="blues">Blues</option>
                <option value="chromatic">Crom√°tica</option>
                <option value="dorian">D√≥rico (Modal)</option>
                <option value="phrygian">Frigio (Modal)</option>
                <option value="lydian">Lidio (Modal)</option>
                <option value="mixolydian">Mixolidio (Modal)</option>
            </select>

            <button class="btn btn-green" onclick="showScale()">üéº Mostrar Escalas</button>

            <div id="scale-result" style="display: none; background: #f0f9ff; border: 3px solid #0ea5e9; border-radius: 10px; padding: 15px; margin-top: 15px;"></div>
        </div>

        <!-- M√≥dulo 04: Arreglo de Voces -->
        <div class="module">
            <h2>
                üé§ Arreglo de Voces
                <button class="help-btn" onclick="toggleHelp(4)">‚ùì Ayuda</button>
            </h2>
            <div id="help-4" class="help-content">
                <strong>Descripci√≥n:</strong> Genera armon√≠as para voces adicionales basadas en un acorde.<br>
                <strong>Uso:</strong> Selecciona la nota base y tipo de acorde, presiona Generar Voces.<br>
                <strong>Ejemplo:</strong> C Mayor generar√°:<br>
                - Melod√≠a Principal: C<br>
                - Segunda Voz (Tercera): E<br>
                - Tercera Voz (Quinta): G
            </div>

            <select id="voice-root" style="padding: 10px; font-weight: bold; margin-right: 10px;">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>

            <select id="voice-type" style="padding: 10px; font-weight: bold; margin-right: 10px;">
                <option value="major">Mayor</option>
                <option value="minor">Menor</option>
                <option value="7">S√©ptima</option>
                <option value="m7">Menor S√©ptima</option>
                <option value="maj7">S√©ptima Mayor</option>
                <option value="dim">Disminuido</option>
                <option value="aug">Aumentado</option>
                <option value="sus2">Sus2</option>
                <option value="sus4">Sus4</option>
            </select>

            <button class="btn btn-green" onclick="generateVoices()">üéµ Generar Voces</button>

            <div id="voice-result" style="display: none; background: #fef3c7; border: 3px solid #f59e0b; border-radius: 10px; padding: 20px; margin-top: 15px;"></div>
        </div>

        <!-- M√≥dulo 05: Pad de Sonidos de Notas -->
        <div class="module">
            <h2>
                üéπ Pad de Sonidos de Notas
                <button class="help-btn" onclick="toggleHelp(5)">‚ùì Ayuda</button>
            </h2>
            <div id="help-5" class="help-content">
                <strong>Descripci√≥n:</strong> Toca notas musicales y crea secuencias.<br>
                <strong>Uso:</strong> Selecciona octava (1-6), activa "Guardar Sonidos", toca las notas para grabar secuencia, ajusta BPM y reproduce.<br>
                <strong>Ejemplo:</strong> Activa grabaci√≥n, toca C-E-G, presiona Reproducir para escuchar tu secuencia.<br>
                <strong>Funciones:</strong> Puedes agregar silencios, activar bucle, y guardar secuencias.
            </div>

            <div class="controls">
                <span style="font-weight: bold; margin-right: 5px;">Octava:</span>
                <button class="btn btn-blue" onclick="changeOctave(-1)">-</button>
                <span class="semitone-counter" id="octave-display">4</span>
                <button class="btn btn-blue" onclick="changeOctave(1)">+</button>
                
                <button class="btn btn-yellow" id="record-toggle" onclick="toggleRecording()">‚è∫Ô∏è Guardar Sonidos</button>
                <button class="btn btn-orange" onclick="addSilence()">üîá Silencio</button>
            </div>

            <div id="note-pad" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;"></div>

            <div class="controls" style="margin-top: 15px;">
                <span style="font-weight: bold; margin-right: 5px;">BPM:</span>
                <button class="btn btn-blue" onclick="changePadBPM(-5)">-</button>
                <span class="semitone-counter" id="pad-bpm">160</span>
                <button class="btn btn-blue" onclick="changePadBPM(5)">+</button>
                
                <button class="btn btn-green" id="play-sequence" onclick="playSequence()">‚ñ∂Ô∏è Reproducir</button>
                <button class="btn btn-purple" id="loop-toggle" onclick="toggleLoop()">üîÅ Bucle</button>
                <button class="btn btn-orange" id="edit-sequence" onclick="toggleEditMode()">‚úèÔ∏è Editar</button>
                <button class="btn btn-red" onclick="resetPad()">üîÑ Reiniciar</button>
            </div>

            <div id="note-sequence" class="history-box" style="min-height: 100px;"></div>

            <div style="margin-top: 15px;">
                <input type="text" id="pad-title" placeholder="T√≠tulo de secuencia...">
                <button class="btn btn-green" onclick="savePadSequence()">üíæ Guardar Secuencia</button>
                <button class="btn btn-red" onclick="deleteSelectedPadSequences()">üóëÔ∏è Eliminar</button>
            </div>

            <div id="pad-sequences" class="history-box"></div>
        </div>

        <!-- M√≥dulo 06: Acorde Inverso -->
        <div class="module">
            <h2>
                üîç Acorde Inverso
                <button class="help-btn" onclick="toggleHelp(6)">‚ùì Ayuda</button>
            </h2>
            <div id="help-6" class="help-content">
                <strong>Descripci√≥n:</strong> Identifica acordes a partir de una serie de notas.<br>
                <strong>Uso:</strong> Ingresa entre 3 y 18 notas separadas por comas o espacios (ej: C E G o C, E, G). Presiona Analizar.<br>
                <strong>Ejemplo:</strong> "C E G" identificar√° "C Mayor (C, E, G)"<br>
                <strong>Nota:</strong> Las notas se convertir√°n autom√°ticamente a MAY√öSCULAS.
            </div>

            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="chord-finder-input" placeholder="Ej: C E G  o  C, E, G, B" style="flex: 1; min-width: 200px; text-transform: uppercase;">
                <button class="btn btn-green" onclick="findChords()">üîç Analizar</button>
                <button class="btn btn-red" onclick="resetChordFinder()">üîÑ Reiniciar</button>
            </div>

            <div id="chord-finder-result" style="display: none; background: #f0fdf4; border: 3px solid #22c55e; border-radius: 10px; padding: 15px; margin-top: 15px;"></div>
        </div>

        <!-- M√≥dulo 07: Generador de Progresiones de Ejemplo -->
        <div class="module">
            <h2>
                üìä Generador de Progresiones de Ejemplo
                <button class="help-btn" onclick="toggleHelp(7)">‚ùì Ayuda</button>
            </h2>
            <div id="help-7" class="help-content">
                <strong>Descripci√≥n:</strong> Genera progresiones arm√≥nicas cl√°sicas autom√°ticamente.<br>
                <strong>Uso:</strong> Selecciona tonalidad (C, D, E...) y tipo de escala (Mayor/Menor), presiona Generar.<br>
                <strong>Ejemplo:</strong> C Mayor genera:<br>
                - I (C): C, E, G<br>
                - ii (Dm): D, F, A<br>
                - iii (Em): E, G, B<br>
                - IV (F): F, A, C<br>
                - V (G): G, B, D<br>
                - vi (Am): A, C, E<br>
                - vii¬∞ (Bdim): B, D, F
            </div>

            <select id="progression-root" style="padding: 10px; font-weight: bold; margin-right: 10px;">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
            </select>

            <select id="progression-scale" style="padding: 10px; font-weight: bold; margin-right: 10px;">
                <option value="major">Mayor</option>
                <option value="minor">Menor</option>
            </select>

            <button class="btn btn-green" onclick="generateProgression()">üéº Generar</button>

            <div id="progression-result" style="display: none; background: #fef3c7; border: 3px solid #f59e0b; border-radius: 10px; padding: 15px; margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let currentTheme = 'light';
        let semitones = 0;
        let transposeMode = 'sharp';
        let outputFontSize = 11;
        let historyData = [];
        
        // Variables del Metr√≥nomo
        let metronomeInterval = null;
        let metronomeBPM = 120;
        let metronomeRunning = false;
        let metronomeCurrentBeat = 0;
        let metronomeSessions = [];
        let audioContext = null;

        // Variables del Pad de Sonidos
        let currentOctave = 4;
        let noteSequence = [];
        let isRecording = false;
        let isLooping = false;
        let padBPM = 160;
        let isPlayingSequence = false;
        let padSequences = [];
        let isEditingSequence = false;
        let selectedNoteIndex = -1;
        let tempEditBuffer = [];

        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const notesFlat = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const notesSolfeo = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];

        const noteColors = [
            '#ff6b6b', '#ee5a6f', '#f06595', '#cc5de8',
            '#845ef7', '#5c7cfa', '#339af0', '#22b8cf',
            '#20c997', '#51cf66', '#94d82d', '#ffd43b'
        ];

        // Intervalos de escalas
        const scaleIntervals = {
            'major': [0, 2, 4, 5, 7, 9, 11],
            'minor': [0, 2, 3, 5, 7, 8, 10],
            'harmonic-minor': [0, 2, 3, 5, 7, 8, 11],
            'melodic-minor': [0, 2, 3, 5, 7, 9, 11],
            'pentatonic-major': [0, 2, 4, 7, 9],
            'pentatonic-minor': [0, 3, 5, 7, 10],
            'blues': [0, 3, 5, 6, 7, 10],
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            'dorian': [0, 2, 3, 5, 7, 9, 10],
            'phrygian': [0, 1, 3, 5, 7, 8, 10],
            'lydian': [0, 2, 4, 6, 7, 9, 11],
            'mixolydian': [0, 2, 4, 5, 7, 9, 10]
        };

        // Cualidades de acordes por grado
        const chordQualities = {
            'major': ['', 'm', 'm', '', '', 'm', 'dim'],
            'minor': ['m', 'dim', '', 'm', 'm', '', ''],
            'harmonic-minor': ['m', 'dim', 'aug', 'm', '', '', 'dim'],
            'melodic-minor': ['m', 'm', 'aug', '', '', 'dim', 'dim'],
            'dorian': ['m', 'm', '', '', 'm', 'dim', ''],
            'phrygian': ['m', '', '', 'm', 'dim', '', 'm'],
            'lydian': ['', '', 'm', 'dim', '', 'm', 'm'],
            'mixolydian': ['', 'm', 'dim', '', 'm', 'm', '']
        };

        // Definici√≥n de intervalos para cada tipo de acorde
        const chordIntervals = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            'dim': [0, 3, 6],
            'aug': [0, 4, 8],
            '7': [0, 4, 7, 10],
            'm7': [0, 3, 7, 10],
            'maj7': [0, 4, 7, 11],
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9],
            '9': [0, 4, 7, 10, 14],
            'add9': [0, 4, 7, 14],
            'dim7': [0, 3, 6, 9]
        };

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playClick(frequency, duration = 0.1) {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playNote(frequency, duration = 0.3) {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function getNoteFrequency(note, octave) {
            const noteIndex = notes.indexOf(note);
            const A4 = 440;
            const semitoneOffset = (octave - 4) * 12 + (noteIndex - 9);
            return A4 * Math.pow(2, semitoneOffset / 12);
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.className = currentTheme;
        }

        function toggleHelp(moduleNum) {
            const help = document.getElementById('help-' + moduleNum);
            help.style.display = help.style.display === 'none' || !help.style.display ? 'block' : 'none';
        }

        function changeSemitones(change) {
            semitones += change;
            document.getElementById('semitone-count').textContent = semitones > 0 ? '+' + semitones : semitones;
            transposeNotes();
        }

        function changeMode(mode) {
            transposeMode = mode;
            document.querySelectorAll('[id^="mode-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            transposeNotes();
        }

        function changeFontSize(change) {
            if (change === 0) outputFontSize = 11;
            else outputFontSize = Math.max(8, Math.min(24, outputFontSize + change * 2));
            
            const output = document.getElementById('transpose-output');
            output.style.fontSize = outputFontSize + 'pt';
            output.style.height = '300px';
            output.style.overflowY = 'auto';
        }

        function isMusicalNote(word) {
            const pattern = /^[A-G](b|#)?(m|7|m7|maj7|dim|sus2|sus4|add9)?$/;
            return pattern.test(word);
        }

        function transposeNote(note, semitonesShift, mode) {
            let match = note.match(/^([A-G](b|#)?)(.*)/);
            if (!match) return note;
            
            let baseNote = match[1];
            let suffix = match[3];
            let hasFlat = baseNote.includes('b');
            
            if (hasFlat) {
                const flatMap = {
                    'Bb': 'A#', 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#'
                };
                baseNote = flatMap[baseNote] || baseNote;
            }
            
            let index = notes.indexOf(baseNote);
            if (index === -1) return note;
            
            index = (index + semitonesShift + 12 * 100) % 12;
            
            let resultNote;
            if (hasFlat) {
                resultNote = notes[index];
            } else {
                if (mode === 'flat') {
                    resultNote = notesFlat[index];
                } else if (mode === 'solfeo') {
                    resultNote = notesSolfeo[index];
                } else {
                    resultNote = notes[index];
                }
            }
            
            return resultNote + suffix;
        }

        function transposeNotes() {
            const input = document.getElementById('transpose-input').value;
            if (!input) {
                document.getElementById('transpose-output').value = '';
                return;
            }
            
            const lines = input.split('\n');
            const output = [];

            for (let line of lines) {
                if (line.includes(':')) {
                    const colonIndex = line.indexOf(':');
                    const label = line.substring(0, colonIndex + 1);
                    const content = line.substring(colonIndex + 1);
                    output.push(label + transposeLine(content));
                } else {
                    output.push(transposeLine(line));
                }
            }

            document.getElementById('transpose-output').value = output.join('\n');
        }

        function transposeLine(line) {
            let result = '';
            let currentWord = '';
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (/[\s\-_/()*\/]/.test(char)) {
                    if (currentWord) {
                        if (isMusicalNote(currentWord)) {
                            result += transposeNote(currentWord, semitones, transposeMode);
                        } else {
                            result += currentWord;
                        }
                        currentWord = '';
                    }
                    result += char;
                } else {
                    currentWord += char;
                }
            }
            
            if (currentWord) {
                if (isMusicalNote(currentWord)) {
                    result += transposeNote(currentWord, semitones, transposeMode);
                } else {
                    result += currentWord;
                }
            }
            
            return result;
        }

        function copyTransposed() {
            const output = document.getElementById('transpose-output');
            output.select();
            document.execCommand('copy');
            alert('¬°Copiado al portapapeles!');
        }

        function resetTranspose() {
            semitones = 0;
            document.getElementById('semitone-count').textContent = '0';
            document.getElementById('transpose-input').value = '';
            document.getElementById('transpose-output').value = '';
            outputFontSize = 11;
            document.getElementById('transpose-output').style.fontSize = '11pt';
        }

        function saveToHistory() {
            const title = document.getElementById('history-title').value.trim();
            const content = document.getElementById('transpose-output').value;
            
            if (!title || !content) {
                alert('Por favor ingresa un t√≠tulo y contenido para guardar');
                return;
            }

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const preview = content.split('\n')[0].substring(0, 50);
            
            historyData.push({ date, title, content, preview });
            document.getElementById('history-title').value = '';
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            
            if (historyData.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay registros guardados</p>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < historyData.length; i++) {
                const item = historyData[i];
                html += `
                    <div style="border: 4px solid #000; padding: 12px; margin-bottom: 12px; border-radius: 10px; background: #fff; display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center;">
                        <input type="checkbox" id="hist-${i}" value="${i}" style="width: 20px; height: 20px;">
                        
                        <div style="min-width: 0;">
                            <div id="title-display-${i}" style="font-weight: bold; font-size: 11pt; margin-bottom: 6px; color: #000;">${item.title}</div>
                            <input type="text" id="title-edit-${i}" value="${item.title}" style="display: none; width: 100%; padding: 8px; border: 3px solid #333; border-radius: 8px; font-weight: bold; font-size: 11pt; margin-bottom: 6px; background: #fff; color: #000;">
                            <div style="color: #666; font-size: 0.75rem; margin-bottom: 3px;">üìÖ ${item.date}</div>
                            <div style="color: #555; font-size: 0.7rem;">üìù ${item.preview}...</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-wrap: nowrap;">
                            <button id="edit-btn-${i}" onclick="toggleEditMode(${i})" style="padding: 8px 16px; background: #a855f7; color: #fff; border: 3px solid #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; white-space: nowrap;">Editar</button>
                            <button onclick="loadHistory(${i})" style="padding: 8px 16px; background: #22c55e; color: #000; border: 3px solid #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; white-space: nowrap;">Cargar</button>
                        </div>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }

        let editingIndex = -1;

        function toggleEditMode(index) {
            const displayEl = document.getElementById('title-display-' + index);
            const editEl = document.getElementById('title-edit-' + index);
            const btnEl = document.getElementById('edit-btn-' + index);
            
            if (editingIndex === index) {
                // Guardar cambios
                const newTitle = editEl.value.trim();
                if (!newTitle) {
                    alert('‚ùå El t√≠tulo no puede estar vac√≠o');
                    return;
                }
                historyData[index].title = newTitle;
                historyData[index].date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                editingIndex = -1;
                renderHistory();
                alert('‚úÖ T√≠tulo actualizado correctamente');
            } else {
                // Activar modo edici√≥n
                displayEl.style.display = 'none';
                editEl.style.display = 'block';
                editEl.focus();
                btnEl.textContent = 'Guardar';
                btnEl.style.background = '#3b82f6';
                editingIndex = index;
            }
        }

        function editHistoryTitle(index) {
            // Esta funci√≥n ya no se usa, pero la dejamos por compatibilidad
            toggleEditMode(index);
        }

        function loadHistory(index) {
            const item = historyData[index];
            document.getElementById('transpose-input').value = item.content;
            transposeNotes();
        }

        function deleteSelectedHistory() {
            const checkboxes = document.querySelectorAll('[id^="hist-"]:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
            indices.forEach(index => historyData.splice(index, 1));
            renderHistory();
        }

        // M√ìDULO 02: METR√ìNOMO

        function changeBPM(change) {
            metronomeBPM = Math.max(40, Math.min(240, metronomeBPM + change));
            document.getElementById('bpm-display').textContent = metronomeBPM;
            if (metronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        function updateMetronome() {
            const signature = document.getElementById('time-signature').value;
            const beats = parseInt(signature.split('/')[0]);
            renderMetronomeBeats(beats);
            if (metronomeRunning) {
                stopMetronome();
                startMetronome();
            }
        }

        function renderMetronomeBeats(count) {
            const container = document.getElementById('metronome-beats');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const circle = document.createElement('div');
                circle.style.cssText = `
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    border: 4px solid #333;
                    background: #e5e7eb;
                    transition: all 0.1s;
                `;
                circle.id = 'beat-' + i;
                if (i === 0) circle.classList.add('first-beat');
                container.appendChild(circle);
            }
        }

        function toggleMetronome() {
            metronomeRunning = !metronomeRunning;
            const btn = document.getElementById('metronome-toggle');
            
            if (metronomeRunning) {
                btn.textContent = '‚è∏Ô∏è Detener';
                btn.classList.remove('btn-green');
                btn.classList.add('btn-red');
                startMetronome();
            } else {
                btn.textContent = '‚ñ∂Ô∏è Iniciar';
                btn.classList.remove('btn-red');
                btn.classList.add('btn-green');
                stopMetronome();
            }
        }

        function startMetronome() {
            const signature = document.getElementById('time-signature').value;
            const beats = parseInt(signature.split('/')[0]);
            const subdivision = parseInt(document.getElementById('subdivision').value);
            const interval = 60000 / (metronomeBPM * subdivision);
            
            metronomeCurrentBeat = 0;
            let subBeat = 0;
            
            metronomeInterval = setInterval(() => {
                if (subBeat === 0) {
                    document.querySelectorAll('[id^="beat-"]').forEach(c => {
                        c.style.background = '#e5e7eb';
                        c.style.transform = 'scale(1)';
                        c.style.boxShadow = 'none';
                    });
                    
                    const currentCircle = document.getElementById('beat-' + metronomeCurrentBeat);
                    if (metronomeCurrentBeat === 0) {
                        currentCircle.style.background = '#ef4444';
                        currentCircle.style.boxShadow = '0 0 30px #ef4444';
                    } else {
                        currentCircle.style.background = '#22c55e';
                        currentCircle.style.boxShadow = '0 0 30px #22c55e';
                    }
                    currentCircle.style.transform = 'scale(1.1)';
                }
                
                const frequency = metronomeCurrentBeat === 0 ? 1000 : 800;
                playClick(frequency, 0.05);
                
                subBeat++;
                if (subBeat >= subdivision) {
                    subBeat = 0;
                    metronomeCurrentBeat = (metronomeCurrentBeat + 1) % beats;
                }
            }, interval);
        }

        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            document.querySelectorAll('[id^="beat-"]').forEach(c => {
                c.style.background = '#e5e7eb';
                c.style.transform = 'scale(1)';
                c.style.boxShadow = 'none';
            });
        }

        function saveMetronomeSession() {
            const title = document.getElementById('metronome-session-title').value.trim();
            if (!title) {
                alert('Por favor ingresa un t√≠tulo para la sesi√≥n');
                return;
            }

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const session = {
                date,
                title,
                bpm: metronomeBPM,
                signature: document.getElementById('time-signature').value,
                subdivision: document.getElementById('subdivision').value
            };
            
            metronomeSessions.push(session);
            document.getElementById('metronome-session-title').value = '';
            renderMetronomeSessions();
        }

        function renderMetronomeSessions() {
            const list = document.getElementById('metronome-sessions');
            
            if (metronomeSessions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay sesiones guardadas</p>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < metronomeSessions.length; i++) {
                const item = metronomeSessions[i];
                html += `
                    <div style="border: 4px solid #000; padding: 12px; margin-bottom: 12px; border-radius: 10px; background: #fff; display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center;">
                        <input type="checkbox" id="metro-${i}" value="${i}" style="width: 20px; height: 20px;">
                        
                        <div style="min-width: 0;">
                            <div id="metro-title-display-${i}" style="font-weight: bold; font-size: 11pt; margin-bottom: 6px; color: #000;">${item.title}</div>
                            <input type="text" id="metro-title-edit-${i}" value="${item.title}" style="display: none; width: 100%; padding: 8px; border: 3px solid #333; border-radius: 8px; font-weight: bold; font-size: 11pt; margin-bottom: 6px; background: #fff; color: #000;">
                            <div style="color: #666; font-size: 0.75rem; margin-bottom: 3px;">üìÖ ${item.date}</div>
                            <div style="color: #555; font-size: 0.7rem;">üéµ BPM: ${item.bpm} | Comp√°s: ${item.signature}</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-wrap: nowrap;">
                            <button id="metro-edit-btn-${i}" onclick="toggleMetronomeEditMode(${i})" style="padding: 8px 16px; background: #a855f7; color: #fff; border: 3px solid #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; white-space: nowrap;">Editar</button>
                            <button onclick="loadMetronomeSession(${i})" style="padding: 8px 16px; background: #22c55e; color: #000; border: 3px solid #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; white-space: nowrap;">Cargar</button>
                        </div>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }

        let editingMetronomeIndex = -1;

        function toggleMetronomeEditMode(index) {
            const displayEl = document.getElementById('metro-title-display-' + index);
            const editEl = document.getElementById('metro-title-edit-' + index);
            const btnEl = document.getElementById('metro-edit-btn-' + index);
            
            if (editingMetronomeIndex === index) {
                const newTitle = editEl.value.trim();
                if (!newTitle) {
                    alert('‚ùå El t√≠tulo no puede estar vac√≠o');
                    return;
                }
                metronomeSessions[index].title = newTitle;
                metronomeSessions[index].date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                editingMetronomeIndex = -1;
                renderMetronomeSessions();
                alert('‚úÖ T√≠tulo actualizado correctamente');
            } else {
                displayEl.style.display = 'none';
                editEl.style.display = 'block';
                editEl.focus();
                btnEl.textContent = 'Guardar';
                btnEl.style.background = '#3b82f6';
                editingMetronomeIndex = index;
            }
        }

        function loadMetronomeSession(index) {
            const session = metronomeSessions[index];
            metronomeBPM = session.bpm;
            document.getElementById('bpm-display').textContent = metronomeBPM;
            document.getElementById('time-signature').value = session.signature;
            document.getElementById('subdivision').value = session.subdivision;
            updateMetronome();
        }

        function deleteSelectedMetronomeSessions() {
            const checkboxes = document.querySelectorAll('[id^="metro-"]:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
            indices.forEach(index => metronomeSessions.splice(index, 1));
            renderMetronomeSessions();
        }

        // M√ìDULO 03: ACORDES Y ESCALAS ARM√ìNICAS

        function getChordNotes(root, quality) {
            const rootIndex = notes.indexOf(root);
            const intervals = chordIntervals[quality] || [0, 4, 7];
            return intervals.map(interval => notes[(rootIndex + interval) % 12]);
        }

        function showScale() {
            const root = document.getElementById('scale-root').value;
            const scaleType = document.getElementById('scale-type').value;
            const intervals = scaleIntervals[scaleType];
            
            if (!intervals) {
                alert('Escala no encontrada');
                return;
            }
            
            const rootIndex = notes.indexOf(root);
            const scaleNotes = intervals.map(interval => notes[(rootIndex + interval) % 12]);
            
            const scaleTypeName = document.getElementById('scale-type').selectedOptions[0].text;
            
            let result = `<h3 style="color: #0284c7; margin-bottom: 15px;">üìä Escala: ${root} ${scaleTypeName}</h3>`;
            result += `<p style="font-size: 1.1rem; margin-bottom: 20px;"><strong>üéµ Notas de la escala:</strong> ${scaleNotes.join(' - ')}</p>`;
            
            // Mostrar acordes solo si la escala tiene cualidades definidas
            if (chordQualities[scaleType]) {
                const qualities = chordQualities[scaleType];
                const degrees = scaleType.includes('minor') || scaleType === 'dorian' || scaleType === 'phrygian' 
                    ? ['i', 'ii', 'III', 'iv', 'v', 'VI', 'VII']
                    : ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii'];
                
                result += '<hr style="margin: 20px 0; border: 1px solid #0ea5e9;">';
                result += '<h4 style="color: #0284c7; margin-bottom: 15px;">üé∏ Acordes de la escala:</h4>';
                result += '<div style="text-align: left;">';
                
                scaleNotes.forEach((note, index) => {
                    if (index < qualities.length) {
                        const quality = qualities[index];
                        const degree = degrees[index] || (index + 1);
                        const chordNotes = getChordNotes(note, quality);
                        
                        result += `
                            <div style="background: #e0f2fe; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #0284c7;">
                                <strong style="font-size: 1.1rem; color: #0c4a6e;">${degree} - ${note}${quality}:</strong>
                                <span style="color: #0369a1; margin-left: 10px;">${chordNotes.join(', ')}</span>
                            </div>
                        `;
                    }
                });
                
                result += '</div>';
            } else {
                result += '<p style="margin-top: 20px; color: #666;"><em>Esta escala no tiene acordes predefinidos (Pentat√≥nica, Blues, Crom√°tica)</em></p>';
            }
            
            document.getElementById('scale-result').innerHTML = result;
            document.getElementById('scale-result').style.display = 'block';
        }

        // M√ìDULO 04: ARREGLO DE VOCES

        function generateVoices() {
            const root = document.getElementById('voice-root').value;
            const type = document.getElementById('voice-type').value;
            const typeName = document.getElementById('voice-type').selectedOptions[0].text;
            
            const chordNotes = getChordNotes(root, type);
            
            let result = `<h3 style="color: #d97706; margin-bottom: 20px; text-align: center;">üé§ Arreglo de Voces - ${root}${type === 'major' ? '' : type}</h3>`;
            
            result += '<div style="text-align: center; margin: 30px 0;">';
            
            // Melod√≠a Principal
            result += `
                <div style="background: #fef3c7; padding: 20px; margin-bottom: 15px; border-radius: 10px; border: 3px solid #f59e0b;">
                    <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 5px;">üéµ Melod√≠a Principal (Fundamental)</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #d97706;">${chordNotes[0]}</div>
                </div>
            `;
            
            // Segunda Voz (Tercera)
            if (chordNotes[1]) {
                result += `
                    <div style="background: #fed7aa; padding: 20px; margin-bottom: 15px; border-radius: 10px; border: 3px solid #f59e0b;">
                        <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 5px;">üé∂ Segunda Voz (Tercera)</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #c2410c;">${chordNotes[1]}</div>
                    </div>
                `;
            }
            
            // Tercera Voz (Quinta)
            if (chordNotes[2]) {
                result += `
                    <div style="background: #fed7aa; padding: 20px; margin-bottom: 15px; border-radius: 10px; border: 3px solid #f59e0b;">
                        <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 5px;">üéµ Tercera Voz (Quinta)</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #c2410c;">${chordNotes[2]}</div>
                    </div>
                `;
            }
            
            // Cuarta Voz (S√©ptima) - si existe
            if (chordNotes[3]) {
                result += `
                    <div style="background: #fed7aa; padding: 20px; margin-bottom: 15px; border-radius: 10px; border: 3px solid #f59e0b;">
                        <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 5px;">üé∂ Cuarta Voz (S√©ptima)</div>
                        <div style="font-size: 2rem; font-weight: bold; color: #c2410c;">${chordNotes[3]}</div>
                    </div>
                `;
            }
            
            result += '</div>';
            
            // Resumen del acorde
            result += '<hr style="margin: 20px 0; border: 1px solid #f59e0b;">';
            result += `
                <div style="text-align: center; padding: 15px; background: #fffbeb; border-radius: 8px;">
                    <strong style="color: #92400e; font-size: 1.1rem;">üéº Notas del acorde ${root}${type === 'major' ? '' : type}:</strong><br>
                    <span style="color: #d97706; font-size: 1.2rem; font-weight: bold;">${chordNotes.join(' - ')}</span>
                </div>
            `;
            
            // Consejos
            result += `
                <div style="margin-top: 20px; padding: 15px; background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 5px;">
                    <strong style="color: #92400e;">üí° Consejos para el arreglo vocal:</strong>
                    <ul style="margin-top: 10px; color: #78350f; text-align: left; padding-left: 25px;">
                        <li>La melod√≠a principal lleva la nota fundamental del acorde</li>
                        <li>La segunda voz armoniza en tercera (3 semitonos arriba en menor, 4 en mayor)</li>
                        <li>La tercera voz completa el acorde con la quinta</li>
                        ${chordNotes[3] ? '<li>La cuarta voz a√±ade color con la s√©ptima</li>' : ''}
                        <li>Mant√©n el balance de volumen entre todas las voces</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('voice-result').innerHTML = result;
            document.getElementById('voice-result').style.display = 'block';
        }

        // M√ìDULO 05: PAD DE SONIDOS DE NOTAS

        function initNotePad() {
            const pad = document.getElementById('note-pad');
            pad.innerHTML = '';
            
            notes.forEach((note, index) => {
                const btn = document.createElement('button');
                btn.style.cssText = `
                    padding: 20px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    border: 3px solid #000;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: ${noteColors[index]};
                    color: #000;
                `;
                btn.textContent = note;
                btn.onclick = () => playPadNote(note, index);
                pad.appendChild(btn);
            });
        }

        function changeOctave(change) {
            currentOctave = Math.max(1, Math.min(6, currentOctave + change));
            document.getElementById('octave-display').textContent = currentOctave;
        }

        function toggleRecording() {
            isRecording = !isRecording;
            const btn = document.getElementById('record-toggle');
            if (isRecording) {
                btn.classList.add('active');
                btn.textContent = '‚è∫Ô∏è Grabando...';
            } else {
                btn.classList.remove('active');
                btn.textContent = '‚è∫Ô∏è Guardar Sonidos';
            }
        }

        function playPadNote(note, colorIndex) {
            const freq = getNoteFrequency(note, currentOctave);
            playNote(freq, 0.5);
            
            if (isRecording) {
                noteSequence.push({ note, octave: currentOctave, colorIndex });
                renderNoteSequence();
            } else if (isEditingSequence && selectedNoteIndex >= 0) {
                // Agregar nota al buffer temporal de edici√≥n
                tempEditBuffer.push({ note, octave: currentOctave, colorIndex });
                renderNoteSequence();
            }
            
            highlightPadNote(colorIndex);
        }

        function highlightPadNote(index) {
            const buttons = document.querySelectorAll('#note-pad button');
            if (buttons[index]) {
                buttons[index].style.transform = 'scale(1.1)';
                buttons[index].style.boxShadow = '0 0 20px ' + noteColors[index];
                setTimeout(() => {
                    buttons[index].style.transform = '';
                    buttons[index].style.boxShadow = '';
                }, 200);
            }
        }

        function addSilence() {
            if (isRecording) {
                noteSequence.push({ note: 'SILENCIO', octave: 0, colorIndex: -1 });
                renderNoteSequence();
            } else {
                alert('‚ö†Ô∏è Activa "Guardar Sonidos" primero para agregar silencios');
            }
        }

        function renderNoteSequence() {
            const container = document.getElementById('note-sequence');
            if (noteSequence.length === 0 && tempEditBuffer.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay notas grabadas. Activa "Guardar Sonidos" y toca las notas.</p>';
                return;
            }
            
            let html = '<strong style="display: block; margin-bottom: 10px;">üéµ Secuencia grabada:</strong>';
            
            if (isEditingSequence) {
                html += '<p style="color: #f97316; font-weight: bold; margin-bottom: 10px;">‚úèÔ∏è MODO EDICI√ìN: Selecciona una nota para editarla. Las notas que toques reemplazar√°n la seleccionada.</p>';
            }
            
            // Mostrar secuencia actual
            html += noteSequence.map((item, index) => {
                const isSelected = selectedNoteIndex === index;
                const borderStyle = isSelected ? 'border: 3px solid #f97316; box-shadow: 0 0 10px #f97316;' : 'border: 2px solid #333;';
                
                let noteHTML = `<span style="display: inline-block; margin: 3px; padding: 8px 12px; background: ${item.colorIndex >= 0 ? noteColors[item.colorIndex] : '#666'}; color: ${item.colorIndex >= 0 ? '#000' : '#fff'}; border-radius: 5px; cursor: pointer; ${borderStyle} font-weight: bold;" onclick="${isEditingSequence ? 'selectNoteForEdit(' + index + ')' : 'removeNoteFromSequence(' + index + ')'}" title="${isEditingSequence ? 'Click para editar esta nota' : 'Click para eliminar'}">${item.note}${item.octave > 0 ? item.octave : ''}</span>`;
                
                // Si esta nota est√° seleccionada y hay buffer de edici√≥n, mostrar las nuevas notas
                if (isSelected && tempEditBuffer.length > 0) {
                    noteHTML += ' <span style="color: #f97316; font-weight: bold;">‚Üí</span> ';
                    noteHTML += tempEditBuffer.map(newItem => 
                        `<span style="display: inline-block; margin: 3px; padding: 8px 12px; background: ${newItem.colorIndex >= 0 ? noteColors[newItem.colorIndex] : '#666'}; color: ${newItem.colorIndex >= 0 ? '#000' : '#fff'}; border-radius: 5px; border: 3px solid #10b981; box-shadow: 0 0 10px #10b981; font-weight: bold;">${newItem.note}${newItem.octave > 0 ? newItem.octave : ''}</span>`
                    ).join('');
                }
                
                return noteHTML;
            }).join('');
            
            if (isEditingSequence && selectedNoteIndex >= 0) {
                html += '<p style="margin-top: 10px; color: #0369a1; font-weight: bold;">üëâ Tocando: ${tempEditBuffer.length} nota(s). Las nuevas notas reemplazar√°n la seleccionada.</p>';
            }
            
            if (isEditingSequence && selectedNoteIndex < 0) {
                html += '<p style="margin-top: 10px; color: #666; font-style: italic;">Selecciona una nota de la secuencia para comenzar a editar</p>';
            }
            
            container.innerHTML = html;
        }

        function selectNoteForEdit(index) {
            selectedNoteIndex = index;
            tempEditBuffer = []; // Limpiar buffer al seleccionar nueva nota
            renderNoteSequence();
        }

        function toggleEditMode() {
            if (isEditingSequence) {
                // Al salir del modo edici√≥n, aplicar los cambios
                if (selectedNoteIndex >= 0 && tempEditBuffer.length > 0) {
                    // Dividir la secuencia en tres partes
                    const before = noteSequence.slice(0, selectedNoteIndex);
                    const after = noteSequence.slice(selectedNoteIndex + 1);
                    
                    // Reconstruir: antes + nuevas notas + despu√©s
                    noteSequence = [...before, ...tempEditBuffer, ...after];
                    
                    tempEditBuffer = [];
                    selectedNoteIndex = -1;
                }
                
                isEditingSequence = false;
                const btn = document.getElementById('edit-sequence');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Editar';
            } else {
                // Entrar en modo edici√≥n
                isEditingSequence = true;
                selectedNoteIndex = -1;
                tempEditBuffer = [];
                
                const btn = document.getElementById('edit-sequence');
                btn.classList.add('active');
                btn.textContent = 'üíæ Guardar Edici√≥n';
                
                // Desactivar grabaci√≥n si est√° activa
                if (isRecording) {
                    toggleRecording();
                }
            }
            
            renderNoteSequence();
        }

        function removeNoteFromSequence(index) {
            noteSequence.splice(index, 1);
            renderNoteSequence();
        }

        function changePadBPM(change) {
            padBPM = Math.max(40, Math.min(240, padBPM + change));
            document.getElementById('pad-bpm').textContent = padBPM;
        }

        function toggleLoop() {
            isLooping = !isLooping;
            const btn = document.getElementById('loop-toggle');
            btn.classList.toggle('active');
        }

        async function playSequence() {
            if (isPlayingSequence) {
                isPlayingSequence = false;
                return;
            }
            
            if (noteSequence.length === 0) {
                alert('No hay notas en la secuencia');
                return;
            }

            isPlayingSequence = true;
            const btn = document.getElementById('play-sequence');
            btn.textContent = '‚è∏Ô∏è Detener';
            btn.classList.add('btn-red');
            btn.classList.remove('btn-green');

            do {
                for (let i = 0; i < noteSequence.length; i++) {
                    if (!isPlayingSequence) break;
                    
                    const item = noteSequence[i];
                    
                    if (item.note !== 'SILENCIO') {
                        const freq = getNoteFrequency(item.note, item.octave);
                        playNote(freq, 0.4);
                        highlightPadNote(item.colorIndex);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 60000 / padBPM));
                }
            } while (isLooping && isPlayingSequence);

            isPlayingSequence = false;
            btn.textContent = '‚ñ∂Ô∏è Reproducir';
            btn.classList.add('btn-green');
            btn.classList.remove('btn-red');
        }

        function resetPad() {
            noteSequence = [];
            isRecording = false;
            isLooping = false;
            isPlayingSequence = false;
            isEditingSequence = false;
            selectedNoteIndex = -1;
            tempEditBuffer = [];
            currentOctave = 4;
            padBPM = 160;
            
            document.getElementById('octave-display').textContent = currentOctave;
            document.getElementById('pad-bpm').textContent = padBPM;
            document.getElementById('record-toggle').classList.remove('active');
            document.getElementById('record-toggle').textContent = '‚è∫Ô∏è Guardar Sonidos';
            document.getElementById('loop-toggle').classList.remove('active');
            document.getElementById('edit-sequence').classList.remove('active');
            document.getElementById('edit-sequence').textContent = '‚úèÔ∏è Editar';
            document.getElementById('play-sequence').textContent = '‚ñ∂Ô∏è Reproducir';
            document.getElementById('play-sequence').classList.add('btn-green');
            document.getElementById('play-sequence').classList.remove('btn-red');
            renderNoteSequence();
        }

        function savePadSequence() {
            const title = document.getElementById('pad-title').value.trim();
            if (!title || noteSequence.length === 0) {
                alert('Por favor ingresa un t√≠tulo y crea una secuencia');
                return;
            }

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            padSequences.push({ date, title, sequence: [...noteSequence], bpm: padBPM });
            
            document.getElementById('pad-title').value = '';
            renderPadSequences();
        }

        function renderPadSequences() {
            const list = document.getElementById('pad-sequences');
            
            if (padSequences.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay secuencias guardadas</p>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < padSequences.length; i++) {
                const item = padSequences[i];
                html += `
                    <div style="border: 4px solid #000; padding: 12px; margin-bottom: 12px; border-radius: 10px; background: #fff; display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center;">
                        <input type="checkbox" id="pad-${i}" value="${i}" style="width: 20px; height: 20px;">
                        
                        <div style="min-width: 0;">
                            <div id="pad-title-display-${i}" style="font-weight: bold; font-size: 11pt; margin-bottom: 6px; color: #000;">${item.title}</div>
                            <input type="text" id="pad-title-edit-${i}" value="${item.title}" style="display: none; width: 100%; padding: 8px; border: 3px solid #333; border-radius: 8px; font-weight: bold; font-size: 11pt; margin-bottom: 6px; background: #fff; color: #000;">
                            <div style="color: #666; font-size: 0.75rem; margin-bottom: 3px;">üìÖ ${item.date}</div>
                            <div style="color: #555; font-size: 0.7rem;">üéµ Notas: ${item.sequence.length} | BPM: ${item.bpm}</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-wrap: nowrap;">
                            <button id="pad-edit-btn-${i}" onclick="togglePadEditMode(${i})" style="padding: 8px 16px; background: #a855f7; color: #fff; border: 3px solid #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; white-space: nowrap;">Editar</button>
                            <button onclick="loadPadSequence(${i})" style="padding: 8px 16px; background: #22c55e; color: #000; border: 3px solid #000; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; white-space: nowrap;">Cargar</button>
                        </div>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }

        let editingPadIndex = -1;

        function togglePadEditMode(index) {
            const displayEl = document.getElementById('pad-title-display-' + index);
            const editEl = document.getElementById('pad-title-edit-' + index);
            const btnEl = document.getElementById('pad-edit-btn-' + index);
            
            if (editingPadIndex === index) {
                const newTitle = editEl.value.trim();
                if (!newTitle) {
                    alert('‚ùå El t√≠tulo no puede estar vac√≠o');
                    return;
                }
                padSequences[index].title = newTitle;
                padSequences[index].date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                editingPadIndex = -1;
                renderPadSequences();
                alert('‚úÖ T√≠tulo actualizado correctamente');
            } else {
                displayEl.style.display = 'none';
                editEl.style.display = 'block';
                editEl.focus();
                btnEl.textContent = 'Guardar';
                btnEl.style.background = '#3b82f6';
                editingPadIndex = index;
            }
        }

        function loadPadSequence(index) {
            const item = padSequences[index];
            noteSequence = [...item.sequence];
            padBPM = item.bpm;
            document.getElementById('pad-bpm').textContent = padBPM;
            renderNoteSequence();
        }

        function deleteSelectedPadSequences() {
            const checkboxes = document.querySelectorAll('[id^="pad-"]:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
            indices.forEach(index => padSequences.splice(index, 1));
            renderPadSequences();
        }

        // M√ìDULO 06: ACORDE INVERSO

        function normalizeNote(note) {
            // Normalizar bemoles
            const flatMap = { 'BB': 'A#', 'DB': 'C#', 'EB': 'D#', 'GB': 'F#', 'AB': 'G#' };
            note = note.toUpperCase().trim();
            return flatMap[note] || note;
        }

        function findChords() {
            const input = document.getElementById('chord-finder-input').value.toUpperCase().trim();
            if (!input) {
                alert('Por favor ingresa las notas');
                return;
            }

            // Separar por comas o espacios
            let inputNotes = input.split(/[,\s]+/).filter(n => n);
            
            // Validar cantidad
            if (inputNotes.length < 3) {
                alert('‚ö†Ô∏è Por favor ingresa al menos 3 notas');
                return;
            }
            if (inputNotes.length > 18) {
                alert('‚ö†Ô∏è Por favor ingresa m√°ximo 18 notas');
                return;
            }

            // Normalizar notas
            inputNotes = inputNotes.map(note => normalizeNote(note));
            
            // Validar que sean notas v√°lidas
            const validNotes = inputNotes.filter(note => notes.includes(note));
            if (validNotes.length === 0) {
                alert('‚ö†Ô∏è No se encontraron notas v√°lidas. Usa: C, C#, D, D#, E, F, F#, G, G#, A, A#, B (o bemoles: Db, Eb, Gb, Ab, Bb)');
                return;
            }

            // Eliminar duplicados
            const uniqueNotes = [...new Set(validNotes)];

            // Buscar acordes
            const possibleChords = [];

            // Definir todos los tipos de acordes a buscar
            const chordTypes = [
                { name: '', display: 'Mayor', intervals: [0, 4, 7] },
                { name: 'm', display: 'Menor', intervals: [0, 3, 7] },
                { name: '7', display: 'S√©ptima', intervals: [0, 4, 7, 10] },
                { name: 'm7', display: 'Menor S√©ptima', intervals: [0, 3, 7, 10] },
                { name: 'maj7', display: 'S√©ptima Mayor', intervals: [0, 4, 7, 11] },
                { name: 'dim', display: 'Disminuido', intervals: [0, 3, 6] },
                { name: 'dim7', display: 'Disminuido S√©ptima', intervals: [0, 3, 6, 9] },
                { name: 'aug', display: 'Aumentado', intervals: [0, 4, 8] },
                { name: 'sus2', display: 'Suspendido 2', intervals: [0, 2, 7] },
                { name: 'sus4', display: 'Suspendido 4', intervals: [0, 5, 7] },
                { name: '6', display: 'Sexta', intervals: [0, 4, 7, 9] },
                { name: 'm6', display: 'Menor Sexta', intervals: [0, 3, 7, 9] },
                { name: 'add9', display: 'Add9', intervals: [0, 4, 7, 14] }
            ];

            for (let root of notes) {
                const rootIndex = notes.indexOf(root);

                for (let type of chordTypes) {
                    const chordNotes = type.intervals.map(i => notes[(rootIndex + i) % 12]);
                    
                    // Verificar si todas las notas del acorde est√°n en las notas ingresadas
                    const matches = chordNotes.every(note => uniqueNotes.includes(note));
                    
                    if (matches) {
                        possibleChords.push({
                            name: root + type.name,
                            display: root + ' ' + type.display,
                            notes: chordNotes
                        });
                    }
                }
            }

            // Mostrar resultados
            let result = '<h3 style="color: #15803d; margin-bottom: 15px;">üîç An√°lisis de Acordes</h3>';
            result += `<p style="font-size: 1.1rem; margin-bottom: 20px;"><strong>üéµ Notas ingresadas:</strong> <span style="color: #15803d;">${uniqueNotes.join(', ')}</span></p>`;
            
            if (validNotes.length !== inputNotes.length) {
                const invalidNotes = inputNotes.filter(n => !notes.includes(n));
                result += `<p style="color: #dc2626; margin-bottom: 15px;">‚ö†Ô∏è <em>Notas no reconocidas (ignoradas): ${invalidNotes.join(', ')}</em></p>`;
            }
            
            result += '<hr style="margin: 20px 0; border: 1px solid #22c55e;">';
            
            if (possibleChords.length > 0) {
                result += `<h4 style="color: #15803d; margin-bottom: 15px;">‚úÖ Acordes posibles encontrados (${possibleChords.length}):</h4>`;
                result += '<div style="max-height: 400px; overflow-y: auto;">';
                
                possibleChords.forEach(chord => {
                    result += `
                        <div style="background: #dcfce7; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <strong style="font-size: 1.1rem; color: #166534;">${chord.display}</strong>
                            <br>
                            <span style="color: #15803d; margin-top: 5px; display: inline-block;">üìù Notas: ${chord.notes.join(', ')}</span>
                        </div>
                    `;
                });
                
                result += '</div>';
            } else {
                result += '<p style="color: #dc2626; font-size: 1.1rem;">‚ùå No se encontraron acordes comunes con estas notas.</p>';
                result += '<p style="color: #666; margin-top: 10px;"><em>Intenta con diferentes combinaciones de notas o verifica que hayas ingresado al menos las notas b√°sicas de un acorde (3 notas).</em></p>';
            }

            document.getElementById('chord-finder-result').innerHTML = result;
            document.getElementById('chord-finder-result').style.display = 'block';
        }

        function resetChordFinder() {
            document.getElementById('chord-finder-input').value = '';
            document.getElementById('chord-finder-result').style.display = 'none';
        }

        // M√ìDULO 07: GENERADOR DE PROGRESIONES DE EJEMPLO

        function generateProgression() {
            const root = document.getElementById('progression-root').value;
            const scale = document.getElementById('progression-scale').value;
            const rootIndex = notes.indexOf(root);

            let intervals, degrees, qualities, degreeNames;
            
            if (scale === 'major') {
                intervals = [0, 2, 4, 5, 7, 9, 11];
                degrees = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'];
                degreeNames = ['T√≥nica', 'Supert√≥nica', 'Mediante', 'Subdominante', 'Dominante', 'Submediante', 'Sensible'];
                qualities = ['', 'm', 'm', '', '', 'm', 'dim'];
            } else {
                intervals = [0, 2, 3, 5, 7, 8, 10];
                degrees = ['i', 'ii¬∞', 'III', 'iv', 'v', 'VI', 'VII'];
                degreeNames = ['T√≥nica', 'Supert√≥nica', 'Mediante', 'Subdominante', 'Dominante', 'Submediante', 'Subt√≥nica'];
                qualities = ['m', 'dim', '', 'm', 'm', '', ''];
            }

            const scaleNotes = intervals.map(i => notes[(rootIndex + i) % 12]);

            let result = '<h3 style="color: #d97706; margin-bottom: 20px;">üìä Progresi√≥n ' + (scale === 'major' ? 'Mayor' : 'Menor') + ' en ' + root + '</h3>';
            
            result += '<p style="font-size: 1.1rem; margin-bottom: 20px;"><strong>üéµ Escala:</strong> ' + scaleNotes.join(' - ') + '</p>';
            
            result += '<hr style="margin: 20px 0; border: 1px solid #f59e0b;">';
            result += '<h4 style="color: #d97706; margin-bottom: 15px;">üé∏ Acordes de la progresi√≥n:</h4>';
            result += '<div style="text-align: left;">';
            
            scaleNotes.forEach((note, index) => {
                const quality = qualities[index];
                const degree = degrees[index];
                const degreeName = degreeNames[index];
                const chordNotes = getChordNotes(note, quality);
                
                const bgColor = index % 2 === 0 ? '#fef3c7' : '#fed7aa';
                
                result += '<div style="background: ' + bgColor + '; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 5px solid #f59e0b; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                result += '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">';
                result += '<div>';
                result += '<strong style="font-size: 1.3rem; color: #92400e;">' + degree + '</strong>';
                result += '<span style="font-size: 1.2rem; color: #c2410c; margin-left: 10px;">' + note + quality + '</span>';
                result += '<span style="color: #78350f; margin-left: 10px; font-style: italic;">(' + degreeName + ')</span>';
                result += '</div></div>';
                result += '<div style="margin-top: 8px; color: #92400e;"><strong>üìù Notas:</strong> ' + chordNotes.join(', ') + '</div>';
                result += '</div>';
            });
            
            result += '</div>';
            
            result += '<hr style="margin: 20px 0; border: 1px solid #f59e0b;">';
            result += '<div style="background: #fffbeb; padding: 15px; border-radius: 8px; border-left: 4px solid #fbbf24;">';
            result += '<strong style="color: #92400e;">üí° Progresiones comunes en ' + (scale === 'major' ? 'Mayor' : 'Menor') + ':</strong>';
            result += '<ul style="margin-top: 10px; color: #78350f; padding-left: 25px;">';
            
            if (scale === 'major') {
                result += '<li><strong>I - V - vi - IV</strong> (Pop b√°sico)</li>';
                result += '<li><strong>I - IV - V</strong> (Blues/Rock cl√°sico)</li>';
                result += '<li><strong>ii - V - I</strong> (Jazz est√°ndar)</li>';
                result += '<li><strong>I - vi - IV - V</strong> (Doo-wop)</li>';
                result += '<li><strong>I - iii - IV - V</strong> (Balada)</li>';
            } else {
                result += '<li><strong>i - VII - VI - VII</strong> (Rock alternativo)</li>';
                result += '<li><strong>i - iv - v</strong> (Blues menor)</li>';
                result += '<li><strong>i - VI - III - VII</strong> (√âpico)</li>';
                result += '<li><strong>i - v - i - v</strong> (Folk)</li>';
                result += '<li><strong>i - III - VII - VI</strong> (Melanc√≥lico)</li>';
            }
            
            result += '</ul></div>';

            document.getElementById('progression-result').innerHTML = result;
            document.getElementById('progression-result').style.display = 'block';
        }

        // Inicializaci√≥n
        window.onload = function() {
            changeMode('sharp');
            renderHistory();
            renderMetronomeBeats(4);
            renderMetronomeSessions();
            initNotePad();
            renderNoteSequence();
            renderPadSequences();
        };
    </script>
</body>
</html>