<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo 09: Afinador de Instrumentos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }
        body.light { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; }
        body.dark {  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        body.dark .container { background: rgba(30, 30, 30, 0.95); }
        .header { text-align: center; margin-bottom: 30px; position: relative; }
        h1 {
            font-size: 2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        body.dark h1 {
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            padding: 10px 20px;
            border: 3px solid;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        body.light .theme-toggle { background: #fff; color: #333; border-color: #000; }
        body.dark .theme-toggle {  background: #333; color: #fff; border-color: #fff; }
        .module {
            background: white;
            border: 4px solid;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        body.light .module { border-color: #000; }
        body.dark .module { background: #2a2a2a; border-color: #fff; }
        .module h2 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        body.dark .module h2 { color: #60a5fa; }
        .help-btn {
            background: #fbbf24;
            color: #000;
            border: 3px solid #000;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }
        body.dark .help-btn { border-color: #fff; }
        .help-content {
            display: none;
            background: #fef3c7;
            color: #000;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 3px solid #fbbf24;
        }
        body.dark .help-content { background: #3a3a00; color: #fff; border-color: #fbbf24; }
        select {
            width: 100%;
            padding: 12px;
            border: 3px solid;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            margin-bottom: 10px;
            background: white;
            color: #000;
        }
        body.light select { border-color: #000; }
        body.dark select { border-color: #fff; }
        .btn {
            padding: 12px 24px;
            border: 3px solid;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
            font-size: 1rem;
        }
        body.light .btn { border-color: #000; }
        body.dark .btn { border-color: #fff; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .btn-green { background: #22c55e; color: #000; }
        .btn-red { background: #ef4444; color: #fff; }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        /* Estilos espec√≠ficos del afinador */
        .tuner-display {
            background: #f3f4f6;
            border: 4px solid #000;
            border-radius: 15px;
            padding: 30px 20px;
            margin: 20px 0;
            text-align: center;
        }
        body.dark .tuner-display { background: #374151; border-color: #fff; }
        
        .note-display {
            font-size: 4rem;
            font-weight: 900;
            margin: 20px 0;
            color: #667eea;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        body.dark .note-display { color: #60a5fa; }
        
        .frequency-display {
            font-size: 1.5rem;
            color: #666;
            margin-bottom: 10px;
        }
        body.dark .frequency-display { color: #ccc; }
        
        .cents-display {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .tuner-meter {
            position: relative;
            height: 100px;
            background: linear-gradient(to right, 
                #dc2626 0%, 
                #ef4444 10%, 
                #f97316 20%,
                #fbbf24 35%, 
                #22c55e 48%, 
                #16a34a 50%, 
                #22c55e 52%, 
                #fbbf24 65%, 
                #f97316 80%,
                #ef4444 90%, 
                #dc2626 100%);
            border-radius: 12px;
            margin: 20px 0;
            border: 4px solid #000;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }
        body.dark .tuner-meter { border-color: #fff; }
        
        /* Marcas de referencia en el medidor */
        .tuner-meter::before,
        .tuner-meter::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 100%;
            background: rgba(0,0,0,0.5);
            top: 0;
        }
        
        .tuner-meter::before {
            left: 25%;
        }
        
        .tuner-meter::after {
            right: 25%;
        }
        
        .tuner-needle {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #000;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            box-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
        
        .tuner-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.15s ease-out;
            box-shadow: 0 0 20px rgba(0,0,0,0.8), 0 0 40px currentColor;
            z-index: 3;
            border: 3px solid white;
        }
        
        .status-message {
            font-size: 1.3rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 3px solid;
        }
        
        .status-flat {
            background: #fee2e2;
            color: #dc2626;
            border-color: #ef4444;
        }
        
        .status-sharp {
            background: #fef3c7;
            color: #d97706;
            border-color: #fbbf24;
        }
        
        .status-tuned {
            background: #dcfce7;
            color: #16a34a;
            border-color: #22c55e;
        }
        
        .string-reference {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .string-btn {
            padding: 15px 10px;
            background: #e5e7eb;
            border: 4px solid #000;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        body.dark .string-btn { background: #4b5563; border-color: #fff; color: #fff; }
        
        .string-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .string-btn.active {
            animation: pulse-string 0.8s ease-in-out infinite;
            box-shadow: 0 0 30px currentColor;
            transform: scale(1.1);
            border-width: 5px;
        }
        
        @keyframes pulse-string {
            0%, 100% { 
                transform: scale(1.1);
                box-shadow: 0 0 30px currentColor;
            }
            50% { 
                transform: scale(1.15);
                box-shadow: 0 0 40px currentColor, 0 0 60px currentColor;
            }
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .theme-toggle { position: static; margin: 10px auto; display: block; width: fit-content; }
            .note-display { font-size: 3rem; }
            .string-reference { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="light">
    <div class="container">
        <div class="header">
            <h1>üéµ M√≥dulo 09: Afinador de Instrumentos</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåì Modo</button>
        </div>

        <!-- M√≥dulo 09: Afinador de Instrumentos -->
        <div class="module">
            <h2>
                üé∏ Afinador de Instrumentos
                <button class="help-btn" onclick="toggleHelp(9)">‚ùì Ayuda</button>
            </h2>
            <div id="help-9" class="help-content">
                <strong>Descripci√≥n:</strong> Afina tu instrumento usando el micr√≥fono. El afinador detecta la frecuencia y muestra si est√°s afinado.<br><br>
                <strong>C√≥mo usar:</strong><br>
                1. Selecciona tu instrumento (Guitarra, Bajo, Ukelele, etc.)<br>
                2. Presiona "üé§ Iniciar Afinador"<br>
                3. <strong>Permite el acceso al micr√≥fono</strong> cuando el navegador lo pida<br>
                4. Toca una cuerda cerca del micr√≥fono (20-30 cm)<br>
                5. Ajusta la tensi√≥n hasta que el indicador est√© verde y diga "‚úÖ Afinado"<br><br>
                <strong>Lectura del medidor:</strong><br>
                - üî¥ <strong>Rojo (izquierda):</strong> Nota muy baja (bemol) ‚Üí Ajusta m√°s arriba<br>
                - üü° <strong>Amarillo:</strong> Casi afinado ‚Üí Peque√±os ajustes<br>
                - üü¢ <strong>Verde (centro):</strong> ¬°Perfecto! Afinado correctamente<br>
                - üü° <strong>Amarillo (derecha):</strong> Casi afinado ‚Üí Peque√±os ajustes<br>
                - üî¥ <strong>Rojo (derecha):</strong> Nota muy alta (sostenido) ‚Üí Ajusta m√°s abajo<br><br>
                <strong>Cents (¬¢):</strong> Mide la desviaci√≥n en cent√©simas de semitono. Lo ideal es estar entre -5¬¢ y +5¬¢<br><br>
                <strong>Nota:</strong> Se requiere permiso de micr√≥fono en tu navegador.
            </div>

            <!-- Selector de Instrumento -->
            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">üéº Selecciona tu instrumento:</label>
                <select id="instrument-select" onchange="updateInstrument()">
                    <option value="guitar-standard">üé∏ Guitarra Est√°ndar (E A D G B E)</option>
                    <option value="guitar-drop-d">üé∏ Guitarra Drop D (D A D G B E)</option>
                    <option value="bass-4">üé∏ Bajo 4 cuerdas (E A D G)</option>
                    <option value="bass-5">üé∏ Bajo 5 cuerdas (B E A D G)</option>
                    <option value="ukulele">üéª Ukelele (G C E A)</option>
                    <option value="violin">üéª Viol√≠n (G D A E)</option>
                    <option value="chromatic">üéπ Crom√°tico (Todas las notas)</option>
                </select>
            </div>

            <!-- Bot√≥n de activaci√≥n de audio -->
            <div id="audio-activation" style="background: #fef3c7; border: 3px solid #f59e0b; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 1.1rem; font-weight: bold; color: #92400e; margin-bottom: 10px;">
                    üîä Activaci√≥n de Audio Requerida
                </div>
                <div style="color: #78350f; margin-bottom: 15px; font-size: 0.9rem;">
                    Los navegadores requieren interacci√≥n del usuario antes de reproducir audio.
                    <br>Haz clic en el bot√≥n para habilitar los tonos de referencia:
                </div>
                <button class="btn btn-green" onclick="initializeAudio()" style="font-size: 1.1rem; padding: 15px 30px;">
                    üéµ Habilitar Audio de Referencia
                </button>
            </div>

            <!-- Referencia de Cuerdas -->
            <div id="string-reference" class="string-reference"></div>

            <!-- Display del Afinador -->
            <div class="tuner-display">
                <div class="frequency-display" id="frequency-display">-- Hz</div>
                <div class="note-display" id="note-display">‚ô™</div>
                
                <!-- Medidor Visual con etiquetas -->
                <div style="position: relative;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: #666;">
                        <span>Muy bajo ‚¨áÔ∏è</span>
                        <span style="color: #22c55e;">‚úì Perfecto</span>
                        <span>Muy alto ‚¨ÜÔ∏è</span>
                    </div>
                    <div class="tuner-meter">
                        <div class="tuner-needle"></div>
                        <div class="tuner-indicator" id="tuner-indicator"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.75rem; color: #999;">
                        <span>-50¬¢</span>
                        <span>0¬¢</span>
                        <span>+50¬¢</span>
                    </div>
                </div>
                
                <div class="cents-display" id="cents-display">-- cents</div>
                <div class="status-message status-tuned" id="status-message" style="display: none;">
                    ‚úÖ ¬°Afinado!
                </div>
            </div>

            <!-- Controles -->
            <div class="controls" style="justify-content: center;">
                <button class="btn btn-green" id="tuner-toggle" onclick="toggleTuner()">üé§ Iniciar Afinador</button>
                <button class="btn btn-red" onclick="resetTuner()">üîÑ Reiniciar</button>
            </div>

            <!-- Informaci√≥n adicional -->
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 3px solid #0ea5e9; border-radius: 10px; font-size: 0.9rem;">
                <strong style="color: #0284c7;">üí° Consejos para una mejor afinaci√≥n:</strong>
                <ul style="margin-top: 10px; color: #0369a1; padding-left: 25px; line-height: 1.8;">
                    <li><strong>Acerca el instrumento</strong> al micr√≥fono (a 20-30 cm)</li>
                    <li><strong>Lugar silencioso:</strong> sin TV, m√∫sica o ruido de fondo</li>
                    <li><strong>Toca con claridad</strong> cada cuerda y d√©jala vibrar</li>
                    <li><strong>Espera que se estabilice</strong> el indicador antes de ajustar</li>
                    <li><strong>Afina varias veces:</strong> repite cada cuerda 2-3 veces</li>
                    <li><strong>De grave a aguda:</strong> empieza por la 6¬™ cuerda (m√°s gruesa)</li>
                </ul>
            </div>

            <!-- Panel de estad√≠sticas -->
            <div id="tuning-stats" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border: 3px solid #6b7280; border-radius: 10px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">‚è±Ô∏è Tiempo activo</div>
                        <div id="active-time" style="font-size: 1.3rem; font-weight: bold; color: #0284c7;">0:00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">üéØ Afinaciones perfectas</div>
                        <div id="perfect-count" style="font-size: 1.3rem; font-weight: bold; color: #16a34a;">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">üìä Precisi√≥n promedio</div>
                        <div id="avg-precision" style="font-size: 1.3rem; font-weight: bold; color: #7c3aed;">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTheme = 'light';
        let tunerRunning = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let javascriptNode = null;
        let currentInstrument = 'guitar-standard';
        
        // Estad√≠sticas del afinador
        let tunerStartTime = null;
        let perfectTuneCount = 0;
        let tuneReadings = [];
        let statsInterval = null;
        
        // Audio de referencia
        let referenceAudioContext = null;
        let currentReferenceOscillator = null;
        let currentReferenceGain = null;
        let activeReferenceButton = null;
        let audioInitialized = false;
        
        // Definici√≥n de afinaciones por instrumento
        const instrumentTunings = {
            'guitar-standard': {
                name: 'Guitarra Est√°ndar',
                strings: ['E2', 'A2', 'D3', 'G3', 'B3', 'E4'],
                frequencies: [82.41, 110.00, 146.83, 196.00, 246.94, 329.63]
            },
            'guitar-drop-d': {
                name: 'Guitarra Drop D',
                strings: ['D2', 'A2', 'D3', 'G3', 'B3', 'E4'],
                frequencies: [73.42, 110.00, 146.83, 196.00, 246.94, 329.63]
            },
            'bass-4': {
                name: 'Bajo 4 Cuerdas',
                strings: ['E1', 'A1', 'D2', 'G2'],
                frequencies: [41.20, 55.00, 73.42, 98.00]
            },
            'bass-5': {
                name: 'Bajo 5 Cuerdas',
                strings: ['B0', 'E1', 'A1', 'D2', 'G2'],
                frequencies: [30.87, 41.20, 55.00, 73.42, 98.00]
            },
            'ukulele': {
                name: 'Ukelele',
                strings: ['G4', 'C4', 'E4', 'A4'],
                frequencies: [392.00, 261.63, 329.63, 440.00]
            },
            'violin': {
                name: 'Viol√≠n',
                strings: ['G3', 'D4', 'A4', 'E5'],
                frequencies: [196.00, 293.66, 440.00, 659.25]
            },
            'chromatic': {
                name: 'Crom√°tico',
                strings: [],
                frequencies: []
            }
        };

        // Notas y frecuencias crom√°ticas
        const chromaticNotes = [
            { note: 'C', octave: 0, frequency: 16.35 },
            { note: 'C#', octave: 0, frequency: 17.32 },
            { note: 'D', octave: 0, frequency: 18.35 },
            { note: 'D#', octave: 0, frequency: 19.45 },
            { note: 'E', octave: 0, frequency: 20.60 },
            { note: 'F', octave: 0, frequency: 21.83 },
            { note: 'F#', octave: 0, frequency: 23.12 },
            { note: 'G', octave: 0, frequency: 24.50 },
            { note: 'G#', octave: 0, frequency: 25.96 },
            { note: 'A', octave: 0, frequency: 27.50 },
            { note: 'A#', octave: 0, frequency: 29.14 },
            { note: 'B', octave: 0, frequency: 30.87 }
        ];

        // Generar todas las notas hasta 8 octavas
        const allNotes = [];
        for (let octave = 0; octave <= 8; octave++) {
            chromaticNotes.forEach(note => {
                allNotes.push({
                    note: note.note,
                    octave: octave,
                    frequency: note.frequency * Math.pow(2, octave),
                    name: note.note + octave
                });
            });
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.className = currentTheme;
        }

        function toggleHelp(moduleNum) {
            const help = document.getElementById('help-' + moduleNum);
            help.style.display = help.style.display === 'none' || !help.style.display ? 'block' : 'none';
        }

        function updateInstrument() {
            currentInstrument = document.getElementById('instrument-select').value;
            stopReferenceNote(); // Detener cualquier tono de referencia al cambiar instrumento
            renderStringReference();
        }

        function renderStringReference() {
            const container = document.getElementById('string-reference');
            const tuning = instrumentTunings[currentInstrument];
            
            if (tuning.strings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 15px;">Modo crom√°tico: detecta todas las notas</p>';
                return;
            }
            
            let html = '<div style="margin-bottom: 15px; font-weight: bold; text-align: center; font-size: 1.1rem;">üéº Referencia de Cuerdas (haz clic para escuchar):</div>';
            
            // Determinar si es guitarra o bajo para la numeraci√≥n
            const isGuitar = currentInstrument.includes('guitar');
            const isBass = currentInstrument.includes('bass');
            
            tuning.strings.forEach((string, index) => {
                const freq = tuning.frequencies[index].toFixed(2);
                const stringNumber = tuning.strings.length - index; // Inverso: 6ta, 5ta, 4ta...
                
                // Colores diferentes por cuerda para guitarra
                const stringColors = ['#e74c3c', '#e67e22', '#f39c12', '#27ae60', '#3498db', '#9b59b6'];
                const bgColor = stringColors[index] || '#95a5a6';
                
                html += `
                    <div class="string-btn" id="string-${index}" onclick="toggleReferenceNote(${freq}, ${index})" style="background: ${bgColor}; color: white; border-color: #000;">
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 3px;">
                            ${isGuitar ? stringNumber + '¬™ Cuerda' : isBass ? stringNumber + '¬™ Cuerda' : 'Cuerda ' + (index + 1)}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 900;">${string}</div>
                        <div style="font-size: 0.75rem; opacity: 0.85; margin-top: 3px;">${freq} Hz</div>
                        <div id="string-label-${index}" style="font-size: 0.7rem; opacity: 0.9; margin-top: 5px; font-weight: bold;">üîä Tocar</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function initializeAudio() {
            try {
                // Crear y probar el contexto de audio
                if (!referenceAudioContext) {
                    referenceAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Resume el contexto si est√° suspendido
                if (referenceAudioContext.state === 'suspended') {
                    referenceAudioContext.resume();
                }
                
                // Reproducir un tono silencioso de prueba para "desbloquear" el audio
                const testOscillator = referenceAudioContext.createOscillator();
                const testGain = referenceAudioContext.createGain();
                
                testOscillator.connect(testGain);
                testGain.connect(referenceAudioContext.destination);
                
                testGain.gain.setValueAtTime(0, referenceAudioContext.currentTime);
                testOscillator.start(referenceAudioContext.currentTime);
                testOscillator.stop(referenceAudioContext.currentTime + 0.1);
                
                // Marcar como inicializado
                audioInitialized = true;
                
                // Ocultar el panel de activaci√≥n
                document.getElementById('audio-activation').style.display = 'none';
                
                // Mostrar mensaje de √©xito
                const statusMsg = document.getElementById('status-message');
                statusMsg.style.display = 'block';
                statusMsg.className = 'status-message status-tuned';
                statusMsg.textContent = '‚úÖ Audio habilitado correctamente. Ahora puedes usar los tonos de referencia.';
                
                setTimeout(() => {
                    statusMsg.style.display = 'none';
                }, 4000);
                
            } catch (error) {
                console.error('‚ùå Error al inicializar audio:', error);
                alert('‚ùå Error al inicializar el audio:\n\n' + error.message + '\n\nPor favor recarga la p√°gina (F5) e intenta de nuevo.');
            }
        }
        
        function toggleReferenceNote(frequency, index) {
            // Verificar si el audio est√° inicializado
            if (!audioInitialized) {
                alert('‚ö†Ô∏è Primero debes habilitar el audio.\n\nHaz clic en el bot√≥n "üéµ Habilitar Audio de Referencia" arriba.');
                return;
            }
            
            // Si hay un bot√≥n activo y es diferente al clickeado, detenerlo primero
            if (activeReferenceButton !== null && activeReferenceButton !== index) {
                stopReferenceNote();
            }
            
            // Si es el mismo bot√≥n, detener
            if (activeReferenceButton === index) {
                stopReferenceNote();
                return;
            }
            
            // Iniciar nuevo tono
            playReferenceNote(frequency, index);
        }
        
        function playReferenceNote(frequency, index) {
            try {
                // Verificar estado del contexto
                if (!referenceAudioContext || referenceAudioContext.state === 'closed') {
                    alert('‚ö†Ô∏è Error de audio. Por favor recarga la p√°gina (F5).');
                    return;
                }
                
                // Resume el contexto si est√° suspendido
                if (referenceAudioContext.state === 'suspended') {
                    referenceAudioContext.resume();
                }
                
                // Crear oscilador y ganancia
                currentReferenceOscillator = referenceAudioContext.createOscillator();
                currentReferenceGain = referenceAudioContext.createGain();
                
                // Conectar
                currentReferenceOscillator.connect(currentReferenceGain);
                currentReferenceGain.connect(referenceAudioContext.destination);
                
                // Configurar oscilador con diferentes tipos de onda
                currentReferenceOscillator.frequency.value = frequency;
                currentReferenceOscillator.type = 'sine'; // Tono puro
                
                // Fade in suave con volumen m√°s alto
                const now = referenceAudioContext.currentTime;
                currentReferenceGain.gain.setValueAtTime(0, now);
                currentReferenceGain.gain.linearRampToValueAtTime(0.4, now + 0.05);
                
                // Iniciar
                currentReferenceOscillator.start(now);
                
                // Marcar como activo
                activeReferenceButton = index;
                
                // Actualizar UI del bot√≥n
                const btn = document.getElementById('string-' + index);
                const label = document.getElementById('string-label-' + index);
                
                if (btn) {
                    btn.style.transform = 'scale(1.1)';
                    btn.style.boxShadow = '0 0 40px currentColor, 0 8px 25px rgba(0,0,0,0.4)';
                    btn.style.animation = 'pulse-string 1s ease-in-out infinite';
                }
                
                if (label) {
                    label.textContent = '‚è∏Ô∏è Detener';
                    label.style.background = 'rgba(0,0,0,0.3)';
                    label.style.padding = '5px 10px';
                    label.style.borderRadius = '5px';
                }
                
            } catch (error) {
                console.error('‚ùå Error al reproducir tono:', error);
                alert('‚ùå Error al reproducir el tono:\n\n' + error.message + '\n\nIntenta habilitar el audio de nuevo.');
                audioInitialized = false;
                document.getElementById('audio-activation').style.display = 'block';
            }
        }
        
        function stopReferenceNote() {
            if (currentReferenceOscillator && currentReferenceGain && referenceAudioContext) {
                try {
                    const now = referenceAudioContext.currentTime;
                    
                    // Fade out suave
                    currentReferenceGain.gain.cancelScheduledValues(now);
                    currentReferenceGain.gain.setValueAtTime(currentReferenceGain.gain.value, now);
                    currentReferenceGain.gain.linearRampToValueAtTime(0, now + 0.05);
                    
                    // Detener despu√©s del fade out
                    setTimeout(() => {
                        try {
                            if (currentReferenceOscillator) {
                                currentReferenceOscillator.stop();
                                currentReferenceOscillator.disconnect();
                                currentReferenceOscillator = null;
                            }
                            
                            if (currentReferenceGain) {
                                currentReferenceGain.disconnect();
                                currentReferenceGain = null;
                            }
                        } catch (e) {
                            console.warn('Advertencia al limpiar oscilador:', e);
                        }
                    }, 100);
                    
                    console.log('‚è∏Ô∏è Tono de referencia detenido');
                    
                } catch (error) {
                    console.error('Error al detener tono:', error);
                }
            }
            
            // Restaurar UI del bot√≥n
            if (activeReferenceButton !== null) {
                const btn = document.getElementById('string-' + activeReferenceButton);
                const label = document.getElementById('string-label-' + activeReferenceButton);
                
                if (btn) {
                    btn.style.transform = '';
                    btn.style.boxShadow = '';
                    btn.style.animation = '';
                }
                
                if (label) {
                    label.textContent = 'üîä Tocar';
                    label.style.background = '';
                    label.style.padding = '';
                    label.style.borderRadius = '';
                }
                
                activeReferenceButton = null;
            }
        }

        function findClosestNote(frequency) {
            let closest = allNotes[0];
            let minDiff = Math.abs(frequency - closest.frequency);
            
            for (let i = 1; i < allNotes.length; i++) {
                const diff = Math.abs(frequency - allNotes[i].frequency);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = allNotes[i];
                }
            }
            
            // Calcular cents (diferencia en cent√©simas de semitono)
            const cents = Math.round(1200 * Math.log2(frequency / closest.frequency));
            
            return { ...closest, cents };
        }

        function updateTunerDisplay(frequency) {
            if (!frequency || frequency < 20) {
                return;
            }
            
            const result = findClosestNote(frequency);
            
            // Actualizar displays
            document.getElementById('frequency-display').textContent = frequency.toFixed(1) + ' Hz';
            document.getElementById('note-display').textContent = result.name;
            document.getElementById('cents-display').textContent = 
                (result.cents > 0 ? '+' : '') + result.cents + ' cents';
            
            // Guardar lectura para estad√≠sticas
            tuneReadings.push(Math.abs(result.cents));
            if (tuneReadings.length > 50) tuneReadings.shift(); // Mantener √∫ltimas 50 lecturas
            
            // Actualizar indicador visual con animaci√≥n suave
            const indicator = document.getElementById('tuner-indicator');
            const maxCents = 50;
            const percentage = Math.max(-100, Math.min(100, (result.cents / maxCents) * 100));
            const leftPosition = 50 + percentage / 2;
            indicator.style.left = leftPosition + '%';
            
            // Actualizar color del indicador con transiciones suaves
            const absCents = Math.abs(result.cents);
            if (absCents <= 5) {
                indicator.style.background = '#22c55e';
                indicator.style.boxShadow = '0 0 25px #22c55e, 0 0 50px #22c55e';
                
                // Incrementar contador de afinaciones perfectas
                perfectTuneCount++;
                updateStats();
            } else if (absCents <= 15) {
                indicator.style.background = '#fbbf24';
                indicator.style.boxShadow = '0 0 20px #fbbf24';
            } else if (absCents <= 30) {
                indicator.style.background = '#f97316';
                indicator.style.boxShadow = '0 0 20px #f97316';
            } else {
                indicator.style.background = '#ef4444';
                indicator.style.boxShadow = '0 0 20px #ef4444';
            }
            
            // Actualizar mensaje de estado con m√°s precisi√≥n
            const statusMsg = document.getElementById('status-message');
            statusMsg.style.display = 'block';
            
            if (absCents <= 5) {
                statusMsg.className = 'status-message status-tuned';
                statusMsg.textContent = '‚úÖ ¬°Perfecto! Afinado';
            } else if (absCents <= 10) {
                if (result.cents < 0) {
                    statusMsg.className = 'status-message status-flat';
                    statusMsg.textContent = '‚¨áÔ∏è Casi... un poco m√°s bajo';
                } else {
                    statusMsg.className = 'status-message status-sharp';
                    statusMsg.textContent = '‚¨ÜÔ∏è Casi... un poco m√°s alto';
                }
            } else if (result.cents < 0) {
                statusMsg.className = 'status-message status-flat';
                statusMsg.textContent = '‚¨áÔ∏è Muy bajo (bemol) - Ajusta hacia arriba';
            } else {
                statusMsg.className = 'status-message status-sharp';
                statusMsg.textContent = '‚¨ÜÔ∏è Muy alto (sostenido) - Ajusta hacia abajo';
            }
            
            // Destacar cuerda correspondiente
            highlightMatchingString(result.name);
        }
        
        function updateStats() {
            const statsPanel = document.getElementById('tuning-stats');
            if (!tunerStartTime) return;
            
            // Calcular tiempo activo
            const elapsed = Math.floor((Date.now() - tunerStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('active-time').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Actualizar contador de afinaciones perfectas
            document.getElementById('perfect-count').textContent = perfectTuneCount;
            
            // Calcular precisi√≥n promedio
            if (tuneReadings.length > 0) {
                const avg = tuneReadings.reduce((a, b) => a + b, 0) / tuneReadings.length;
                document.getElementById('avg-precision').textContent = '¬±' + avg.toFixed(1) + '¬¢';
            }
        }

        function highlightMatchingString(noteName) {
            const tuning = instrumentTunings[currentInstrument];
            
            // Limpiar highlights anteriores
            document.querySelectorAll('.string-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Buscar y destacar cuerda coincidente
            const matchIndex = tuning.strings.indexOf(noteName);
            if (matchIndex >= 0) {
                const btn = document.getElementById('string-' + matchIndex);
                if (btn) {
                    btn.classList.add('active');
                }
            }
        }

        function autoCorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let best_offset = -1;
            let best_correlation = 0;
            let rms = 0;
            
            // Calcular RMS (Root Mean Square)
            for (let i = 0; i < SIZE; i++) {
                const val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / SIZE);
            
            // No procesar si la se√±al es muy d√©bil
            if (rms < 0.01) return -1;
            
            // Buscar el mejor offset usando autocorrelaci√≥n
            let lastCorrelation = 1;
            for (let offset = 1; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                
                correlation = 1 - (correlation / MAX_SAMPLES);
                
                if (correlation > 0.9 && correlation > lastCorrelation) {
                    const foundGoodCorrelation = correlation > best_correlation;
                    if (foundGoodCorrelation) {
                        best_correlation = correlation;
                        best_offset = offset;
                    }
                }
                
                lastCorrelation = correlation;
            }
            
            if (best_correlation > 0.01 && best_offset !== -1) {
                return sampleRate / best_offset;
            }
            
            return -1;
        }

        async function toggleTuner() {
            if (tunerRunning) {
                stopTuner();
            } else {
                await startTuner();
            }
        }

        async function startTuner() {
            try {
                // Verificar si el navegador soporta getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('‚ùå Tu navegador no soporta acceso al micr√≥fono.\n\nPor favor usa Chrome, Firefox, Edge o Safari actualizado.');
                    return;
                }
                
                // Mostrar mensaje de espera
                const btn = document.getElementById('tuner-toggle');
                btn.textContent = '‚è≥ Esperando permiso...';
                btn.disabled = true;
                
                // Solicitar permiso de micr√≥fono
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                // Crear contexto de audio
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                
                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 2048;
                
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);
                
                const buffer = new Float32Array(2048);
                
                javascriptNode.onaudioprocess = function() {
                    analyser.getFloatTimeDomainData(buffer);
                    const frequency = autoCorrelate(buffer, audioContext.sampleRate);
                    
                    if (frequency > 0) {
                        updateTunerDisplay(frequency);
                    }
                };
                
                tunerRunning = true;
                btn.disabled = false;
                btn.textContent = '‚è∏Ô∏è Detener Afinador';
                btn.classList.remove('btn-green');
                btn.classList.add('btn-red');
                
                // Mostrar mensaje de √©xito
                showNotification('‚úÖ Micr√≥fono activado correctamente', 'success');
                
                // Iniciar estad√≠sticas
                tunerStartTime = Date.now();
                perfectTuneCount = 0;
                tuneReadings = [];
                document.getElementById('tuning-stats').style.display = 'block';
                
                // Actualizar stats cada segundo
                statsInterval = setInterval(updateStats, 1000);
                
            } catch (error) {
                const btn = document.getElementById('tuner-toggle');
                btn.disabled = false;
                btn.textContent = 'üé§ Iniciar Afinador';
                
                console.error('Error completo:', error);
                
                let errorMessage = '';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'üö´ PERMISO DE MICR√ìFONO DENEGADO\n\n';
                    errorMessage += 'üìã Sigue estos pasos:\n\n';
                    errorMessage += '1Ô∏è‚É£ Busca el √≠cono de üîí candado o üé§ micr√≥fono en la barra de direcci√≥n\n';
                    errorMessage += '2Ô∏è‚É£ Haz clic y selecciona "Permitir" o "Allow"\n';
                    errorMessage += '3Ô∏è‚É£ Recarga la p√°gina (F5)\n';
                    errorMessage += '4Ô∏è‚É£ Vuelve a hacer clic en "Iniciar Afinador"\n\n';
                    errorMessage += 'üí° Si usas Claude.ai, algunos navegadores requieren permisos adicionales.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'üé§ NO SE ENCONTR√ì MICR√ìFONO\n\n';
                    errorMessage += 'Verifica que tu dispositivo tenga un micr√≥fono conectado.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '‚ö†Ô∏è MICR√ìFONO EN USO\n\n';
                    errorMessage += 'Cierra otras aplicaciones que puedan estar usando el micr√≥fono\n';
                    errorMessage += '(Zoom, Discord, Skype, etc.)';
                } else {
                    errorMessage = '‚ùå Error: ' + error.name + '\n\n' + error.message;
                }
                
                alert(errorMessage);
                showNotification('‚ùå No se pudo acceder al micr√≥fono', 'error');
            }
        }
        
        function showNotification(message, type) {
            const statusMsg = document.getElementById('status-message');
            statusMsg.style.display = 'block';
            statusMsg.textContent = message;
            
            if (type === 'success') {
                statusMsg.className = 'status-message status-tuned';
            } else {
                statusMsg.className = 'status-message status-flat';
            }
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMsg.style.display = 'none';
                }, 3000);
            }
        }

        function stopTuner() {
            if (javascriptNode) {
                javascriptNode.disconnect();
                javascriptNode = null;
            }
            
            if (analyser) {
                analyser.disconnect();
                analyser = null;
            }
            
            if (microphone) {
                microphone.disconnect();
                microphone.mediaStream.getTracks().forEach(track => track.stop());
                microphone = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            tunerRunning = false;
            const btn = document.getElementById('tuner-toggle');
            btn.textContent = 'üé§ Iniciar Afinador';
            btn.classList.remove('btn-red');
            btn.classList.add('btn-green');
        }

        function resetTuner() {
            stopTuner();
            stopReferenceNote(); // Detener tono de referencia si est√° activo
            
            document.getElementById('frequency-display').textContent = '-- Hz';
            document.getElementById('note-display').textContent = '‚ô™';
            document.getElementById('cents-display').textContent = '-- cents';
            document.getElementById('status-message').style.display = 'none';
            
            const indicator = document.getElementById('tuner-indicator');
            indicator.style.left = '50%';
            indicator.style.background = '#6b7280';
            indicator.style.boxShadow = '0 0 15px rgba(0,0,0,0.5)';
            
            document.querySelectorAll('.string-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Reset stats
            tunerStartTime = null;
            perfectTuneCount = 0;
            tuneReadings = [];
            document.getElementById('tuning-stats').style.display = 'none';
            document.getElementById('active-time').textContent = '0:00';
            document.getElementById('perfect-count').textContent = '0';
            document.getElementById('avg-precision').textContent = '--';
        }

        // Inicializaci√≥n
        window.onload = function() {
            renderStringReference();
            console.log('üé∏ Afinador inicializado correctamente');
            console.log('üí° Haz clic en los botones de cuerdas para escuchar el tono de referencia');
        };
    </script>
</body>
</html>